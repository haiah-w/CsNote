[第八节：kafka、RocketMQ、Pulsar总体架构_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1ia411k7oo/?p=8&spm_id_from=pageDriver&vd_source=ce67cf212f4a949cf75348b5404c5e27)



# 消息队列适用场景/解决的问题

1、**异步化**；

核心业务不需要同步等待非核心业务的情况下，可以异步化非核心业务，提高核心业务的响应速度；

2、**功能解耦**；

系统间非强依赖的功能模块，通过消息队列进行解耦，降低系统复杂度；

3、**流量削峰**；

系统承载不了过多的流量，或者不需要过多的流量，通过消息队列进行缓冲，保证系统可用的情况下，处理业务；

4、**数据重复使用**；

一份数据往往需要多处使用，分发消费的过程可以交给消息队列；

# 消息队列模型

- 生产者：同步、异步向消息队列发送消息；

- 消息队列：提供对消息进行存储(内存、磁盘)、扩展(副本)、过滤、路由(topic)等功能

- 消费者：
  
  - 消息队列推送给消费者
  
  - 消费者拉取消息

|      | Push 推送方式                                 | Pull 拉取方式                                    |
| ---- | ----------------------------------------- | -------------------------------------------- |
| 实时性  | 较强                                        | 较弱                                           |
| 消费机制 | 消费速率由消息队列控制，对于消费速度慢的消费者采取重试；推送失败后对消息缓存，重试 | 消费者建立长轮询，轮询消息队列，不同的消费者各自控制速度、消费位置，失败则重新拉区消息； |
| 组件   | RabbitMQ、ActiveMQ                         | Kafka、RocketMQ、RabbitMQ、ActiveMQ             |

# 消息队列的存储

速度: 内存顺序IO > 内存随机IO > 磁盘顺序IO > 磁盘随机IO

容量: 磁盘 > 内存

磁盘IO访问时间 = 磁头寻道时间(最耗时) + 盘片旋转时间 + 传输时间

顺序IO降低寻道时间，大幅提升磁盘IO性能

# MQ带来了什么问题

### 数据一致性问题

1、消息发送、消费的幂等问题；

2、发送端、消息队列、消费端 消息丢失问题；

### 消息积压问题

1、消费能力不足积压；

# 消费幂等

消息幂等，就是保证不重复消费；

# 保证消息可靠传输

消息在生产到消费，一共经历三个部分：生产者、服务端、消费端

可能存在丢失的场景存在三个：

1、生产者发送消息到消息队列时丢失；

2、消息队列未能持久化消息，宕机丢失；

3、消息消费时，未能消费成功，MQ清除消息或者宕机丢失；

因此解决这三个问题，就从三个方面去考虑：

1、**保证生产端可靠投递**

采用同步方式发送消息，确保收到MQ的成功响应，保证投递成功；

2、**保证MQ端的消息副本同步、持久化**

MQ在收到消息后，保证消息同步到各个MQ副本上，再响应生产端；副本同步成功已经可以保证消息不丢失了；

如果要完全保证，还需要持久化消息，但是会拉低性能；

3、**消费端保证消费完成，MQ才会清除此消息**

当消费端，消费完成，应当响应MQ，去进行对应消息的清理；

# 消息挤压问题

通常是消费端的消费能力不足；
